import type { IndexScore } from './types';
import type { HucData } from './hucDataCollector';
import { computeConfidence, applyConfidenceRegression } from './confidence';

// ── Embedded State-Level EJ Demographic Data ─────────────────────────────────
// Census ACS 5-Year 2018-2022, EPA SDWIS violation rates

const STATE_EJ_DATA: Record<string, {
  poverty: number;
  minority: number;
  uninsured: number;
  lingIso: number;
  noHS: number;
  dwViol: number;
}> = {
  AL: { poverty: 15.5, minority: 35.3, uninsured: 9.8, lingIso: 2.1, noHS: 14.1, dwViol: 22 },
  AK: { poverty: 10.2, minority: 38.5, uninsured: 12.6, lingIso: 4.8, noHS: 7.4, dwViol: 45 },
  AZ: { poverty: 14.1, minority: 46.5, uninsured: 10.4, lingIso: 7.2, noHS: 13.5, dwViol: 18 },
  AR: { poverty: 16.2, minority: 27.4, uninsured: 9.5, lingIso: 2.6, noHS: 13.8, dwViol: 28 },
  CA: { poverty: 11.8, minority: 63.7, uninsured: 7.2, lingIso: 9.8, noHS: 16.4, dwViol: 12 },
  CO: { poverty: 9.1,  minority: 33.9, uninsured: 7.1, lingIso: 4.2, noHS: 8.8,  dwViol: 10 },
  CT: { poverty: 9.8,  minority: 34.8, uninsured: 5.7, lingIso: 4.8, noHS: 9.8,  dwViol: 8 },
  DE: { poverty: 11.3, minority: 41.2, uninsured: 6.8, lingIso: 3.5, noHS: 11.2, dwViol: 14 },
  DC: { poverty: 13.5, minority: 59.8, uninsured: 3.8, lingIso: 5.2, noHS: 10.8, dwViol: 6 },
  FL: { poverty: 12.1, minority: 46.1, uninsured: 13.2, lingIso: 8.1, noHS: 12.2, dwViol: 15 },
  GA: { poverty: 13.5, minority: 47.2, uninsured: 12.4, lingIso: 4.5, noHS: 12.8, dwViol: 16 },
  HI: { poverty: 9.3,  minority: 75.4, uninsured: 4.2, lingIso: 8.8, noHS: 8.2,  dwViol: 20 },
  ID: { poverty: 11.2, minority: 18.6, uninsured: 10.8, lingIso: 3.1, noHS: 9.8,  dwViol: 24 },
  IL: { poverty: 11.5, minority: 39.2, uninsured: 7.2, lingIso: 5.8, noHS: 11.2, dwViol: 14 },
  IN: { poverty: 11.4, minority: 22.8, uninsured: 8.4, lingIso: 2.8, noHS: 11.5, dwViol: 18 },
  IA: { poverty: 11.2, minority: 16.2, uninsured: 5.4, lingIso: 2.4, noHS: 8.2,  dwViol: 26 },
  KS: { poverty: 10.3, minority: 24.8, uninsured: 9.2, lingIso: 3.5, noHS: 9.2,  dwViol: 20 },
  KY: { poverty: 16.3, minority: 15.1, uninsured: 6.2, lingIso: 1.8, noHS: 14.4, dwViol: 22 },
  LA: { poverty: 19.0, minority: 40.2, uninsured: 8.6, lingIso: 2.8, noHS: 14.8, dwViol: 32 },
  ME: { poverty: 11.8, minority: 7.2,  uninsured: 8.1, lingIso: 1.2, noHS: 7.4,  dwViol: 18 },
  MD: { poverty: 9.1,  minority: 49.5, uninsured: 6.2, lingIso: 4.8, noHS: 10.2, dwViol: 10 },
  MA: { poverty: 10.4, minority: 29.8, uninsured: 3.2, lingIso: 5.4, noHS: 9.2,  dwViol: 8 },
  MI: { poverty: 13.1, minority: 25.2, uninsured: 6.4, lingIso: 2.8, noHS: 9.8,  dwViol: 16 },
  MN: { poverty: 9.3,  minority: 22.4, uninsured: 5.1, lingIso: 3.2, noHS: 6.8,  dwViol: 12 },
  MS: { poverty: 19.6, minority: 42.1, uninsured: 12.8, lingIso: 1.8, noHS: 16.2, dwViol: 38 },
  MO: { poverty: 12.8, minority: 21.2, uninsured: 9.8, lingIso: 1.8, noHS: 10.4, dwViol: 24 },
  MT: { poverty: 12.1, minority: 13.8, uninsured: 9.4, lingIso: 1.2, noHS: 6.8,  dwViol: 42 },
  NE: { poverty: 10.5, minority: 22.1, uninsured: 8.2, lingIso: 3.4, noHS: 8.8,  dwViol: 18 },
  NV: { poverty: 11.4, minority: 51.2, uninsured: 12.2, lingIso: 7.8, noHS: 14.1, dwViol: 14 },
  NH: { poverty: 7.2,  minority: 10.8, uninsured: 5.8, lingIso: 1.6, noHS: 6.4,  dwViol: 12 },
  NJ: { poverty: 9.4,  minority: 44.8, uninsured: 7.8, lingIso: 6.8, noHS: 10.8, dwViol: 10 },
  NM: { poverty: 18.2, minority: 63.5, uninsured: 11.5, lingIso: 8.2, noHS: 15.2, dwViol: 48 },
  NY: { poverty: 13.1, minority: 44.2, uninsured: 5.8, lingIso: 8.2, noHS: 13.1, dwViol: 12 },
  NC: { poverty: 13.4, minority: 38.8, uninsured: 11.1, lingIso: 3.8, noHS: 12.4, dwViol: 14 },
  ND: { poverty: 11.4, minority: 15.2, uninsured: 8.2, lingIso: 1.4, noHS: 6.2,  dwViol: 34 },
  OH: { poverty: 13.4, minority: 22.5, uninsured: 6.8, lingIso: 2.2, noHS: 10.2, dwViol: 20 },
  OK: { poverty: 15.3, minority: 34.8, uninsured: 14.2, lingIso: 3.4, noHS: 12.8, dwViol: 26 },
  OR: { poverty: 11.2, minority: 26.4, uninsured: 7.8, lingIso: 4.1, noHS: 9.4,  dwViol: 22 },
  PA: { poverty: 11.8, minority: 24.2, uninsured: 6.1, lingIso: 3.2, noHS: 10.1, dwViol: 16 },
  RI: { poverty: 10.3, minority: 28.2, uninsured: 4.2, lingIso: 5.4, noHS: 12.8, dwViol: 10 },
  SC: { poverty: 14.6, minority: 37.8, uninsured: 10.8, lingIso: 2.4, noHS: 13.2, dwViol: 18 },
  SD: { poverty: 13.1, minority: 18.4, uninsured: 10.2, lingIso: 2.1, noHS: 8.4,  dwViol: 36 },
  TN: { poverty: 13.4, minority: 26.2, uninsured: 10.2, lingIso: 2.4, noHS: 13.1, dwViol: 20 },
  TX: { poverty: 14.2, minority: 59.8, uninsured: 18.4, lingIso: 9.2, noHS: 16.8, dwViol: 22 },
  UT: { poverty: 8.8,  minority: 22.4, uninsured: 9.8, lingIso: 3.8, noHS: 8.4,  dwViol: 16 },
  VT: { poverty: 10.4, minority: 7.8,  uninsured: 5.2, lingIso: 1.1, noHS: 6.2,  dwViol: 14 },
  VA: { poverty: 9.6,  minority: 40.2, uninsured: 8.1, lingIso: 4.2, noHS: 10.8, dwViol: 12 },
  WA: { poverty: 10.3, minority: 34.2, uninsured: 6.8, lingIso: 5.1, noHS: 8.8,  dwViol: 14 },
  WV: { poverty: 17.8, minority: 7.5,  uninsured: 6.2, lingIso: 0.8, noHS: 13.8, dwViol: 52 },
  WI: { poverty: 10.6, minority: 20.2, uninsured: 5.8, lingIso: 2.4, noHS: 8.4,  dwViol: 16 },
  WY: { poverty: 9.8,  minority: 16.2, uninsured: 11.4, lingIso: 1.8, noHS: 6.8,  dwViol: 38 },
};

/**
 * EJ Vulnerability Index (0-100, higher = more EJ burden)
 *
 * Components:
 *   Demographic Baseline (40%): state-level poverty/minority/uninsured/lingIso/noHS
 *   SDWIS Violation Density (40%): violations per system, health-based ratio, pop-weighted
 *   Enforcement Gap (20%): enforcement actions vs violations
 */
export function computeEjVulnerability(data: HucData): IndexScore {
  const now = new Date().toISOString();
  const { stateAbbr, sdwisSystems, sdwisViolations, sdwisEnforcement } = data;

  const ej = STATE_EJ_DATA[stateAbbr];

  // No state data → neutral with low confidence
  if (!ej) {
    return {
      value: 50,
      confidence: Math.min(computeConfidence('ejVulnerability', 0, [], 0), 30),
      trend: 'unknown',
      lastCalculated: now,
      dataPoints: 0,
      tidalModified: false,
    };
  }

  // ── 1. Demographic Baseline (40%) ──
  const povertyNorm = Math.min(100, (ej.poverty / 20) * 100);
  const minorityNorm = Math.min(100, (ej.minority / 70) * 100);
  const uninsuredNorm = Math.min(100, (ej.uninsured / 18) * 100);
  const lingIsoNorm = Math.min(100, (ej.lingIso / 10) * 100);
  const noHSNorm = Math.min(100, (ej.noHS / 18) * 100);

  const demographicScore =
    povertyNorm * 0.35 +
    minorityNorm * 0.15 +
    uninsuredNorm * 0.20 +
    lingIsoNorm * 0.15 +
    noHSNorm * 0.15;

  // ── 2. SDWIS Violation Density (40%) ──
  let violationDensity = 50; // neutral fallback
  const uniqueSystems = new Set(sdwisSystems.map(s => s.pwsid));
  const systemCount = uniqueSystems.size;

  if (systemCount > 0) {
    const violCount = sdwisViolations.length;
    const healthBasedCount = sdwisViolations.filter(v => v.isHealthBased).length;

    // Violations per system (40% of this component)
    const violPerSystem = violCount / systemCount;
    const violPerSystemScore = Math.min(100, violPerSystem * 15);

    // Health-based violation ratio (35% of this component)
    const healthBasedRatio = violCount > 0 ? healthBasedCount / violCount : 0;
    const healthBasedScore = Math.min(100, healthBasedRatio * 150);

    // Population-weighted violations (25% of this component)
    let totalPop = 0;
    for (const sys of sdwisSystems) {
      if (uniqueSystems.has(sys.pwsid) && sys.population > 0) {
        totalPop += sys.population;
      }
    }
    const popWeightedViol = totalPop > 0 ? (violCount / (totalPop / 10000)) : 0;
    const popWeightedScore = Math.min(100, popWeightedViol * 20);

    violationDensity =
      violPerSystemScore * 0.40 +
      healthBasedScore * 0.35 +
      popWeightedScore * 0.25;
  }

  // ── 3. Enforcement Gap (20%) ──
  let enforcementGap = 50; // neutral fallback
  if (sdwisViolations.length > 0) {
    const enforcementRatio = sdwisEnforcement.length / sdwisViolations.length;
    enforcementGap = Math.max(0, Math.min(100, 100 - enforcementRatio * 100));
  }

  // ── Weighted composite ──
  const rawScore =
    demographicScore * 0.40 +
    violationDensity * 0.40 +
    enforcementGap * 0.20;

  // ── Confidence ──
  const dataPoints = systemCount + sdwisViolations.length + sdwisEnforcement.length;
  const dates = [
    ...sdwisViolations.map(v => v.compliancePeriod),
    ...sdwisEnforcement.map(e => e.date),
  ];
  const sources = new Set<string>();
  sources.add('state-ej'); // always present
  if (systemCount > 0) sources.add('sdwis');

  const confidence = computeConfidence('ejVulnerability', dataPoints, dates, sources.size);
  const value = Math.round(Math.max(0, Math.min(100, applyConfidenceRegression(rawScore, confidence))));

  // ── Trend ──
  let trend: IndexScore['trend'] = 'unknown';
  if (sdwisViolations.length >= 3) {
    const healthRatio = sdwisViolations.filter(v => v.isHealthBased).length / sdwisViolations.length;
    const enfRatio = sdwisViolations.length > 0 ? sdwisEnforcement.length / sdwisViolations.length : 0;
    if (enfRatio > 0.8 && healthRatio < 0.2) {
      trend = 'improving';
    } else if (healthRatio > 0.5) {
      trend = 'declining';
    } else {
      trend = 'stable';
    }
  }

  return {
    value,
    confidence,
    trend,
    lastCalculated: now,
    dataPoints,
    tidalModified: false,
  };
}
