/**
 * Flow Vulnerability — per-state streamflow health scoring from cached NWIS IV
 * discharge readings (param 00060, cfs).
 *
 * Blended into the composite state grade at 15% weight by national-summary.ts.
 */

import { getUsgsIvByState, type UsgsIvReading } from './nwisIvCache';
import { PRIORITY_STATES } from './constants';

// ── Types ────────────────────────────────────────────────────────────────────

export interface FlowScore {
  score: number;     // 0–100 composite
  sites: number;     // total discharge sites
  critical: number;  // sites < 1 cfs
  low: number;       // sites 1–10 cfs
  healthy: number;   // sites > 100 cfs
}

// ── Scoring ──────────────────────────────────────────────────────────────────

function scoreSite(cfs: number): number {
  if (cfs < 1) return 30;    // critical drought
  if (cfs <= 10) return 60;  // low flow
  if (cfs <= 100) return 85; // moderate
  return 100;                // healthy
}

/**
 * Compute flow health for a single state from cached NWIS IV discharge data.
 * Returns null when no discharge readings exist.
 */
export function getStateFlowScore(abbr: string): FlowScore | null {
  const readings = getUsgsIvByState(abbr);
  const discharge = readings.filter(r => r.parameterCd === '00060');
  if (discharge.length === 0) return null;

  // Deduplicate by siteNumber — keep latest dateTime
  const bySite = new Map<string, UsgsIvReading>();
  for (const r of discharge) {
    const existing = bySite.get(r.siteNumber);
    if (!existing || r.dateTime > existing.dateTime) {
      bySite.set(r.siteNumber, r);
    }
  }

  let scoreSum = 0;
  let critical = 0;
  let low = 0;
  let healthy = 0;

  for (const r of bySite.values()) {
    const s = scoreSite(r.value);
    scoreSum += s;
    if (r.value < 1) critical++;
    else if (r.value <= 10) low++;
    else if (r.value > 100) healthy++;
  }

  const sites = bySite.size;
  return {
    score: Math.round(scoreSum / sites),
    sites,
    critical,
    low,
    healthy,
  };
}

/**
 * Compute flow scores for all 19 priority states.
 * States without discharge data are omitted from the result.
 */
export function getAllStateFlowScores(): Record<string, FlowScore> {
  const result: Record<string, FlowScore> = {};
  for (const abbr of PRIORITY_STATES) {
    const fs = getStateFlowScore(abbr);
    if (fs) result[abbr] = fs;
  }
  return result;
}
