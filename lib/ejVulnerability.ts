// lib/ejVulnerability.ts
// State-level Environmental Justice vulnerability scoring
// Composite of Census ACS socioeconomic indicators + EPA environmental burden data
// Methodology mirrors EPA EJScreen's approach at the state level:
//   EJ Index = Environmental Burden × Demographic Vulnerability
//
// Sources:
//   - U.S. Census Bureau, American Community Survey 5-Year Estimates (2018-2022)
//   - EPA Safe Drinking Water Information System (SDWIS) violation data
//   - CDC Social Vulnerability Index (SVI) supplemental indicators
//
// Per-waterbody EJScreen API lookups still provide granular, site-level scores
// when the EPA EJScreen REST service is available. This module provides the
// state-level overlay and fallback.

export interface EJStateData {
  abbr: string;
  povertyPct: number;         // % below federal poverty level (ACS)
  minorityPct: number;        // % non-white population (ACS)
  uninsuredPct: number;       // % without health insurance (ACS)
  lingIsolatedPct: number;    // % limited English proficiency households (ACS)
  noHSDiplomaPct: number;     // % 25+ without high school diploma (ACS)
  drinkingWaterViol: number;  // Drinking water violations per 100k pop (EPA SDWIS)
  score: number;              // Computed 0-100 EJ vulnerability composite
}

// ── State-Level Socioeconomic & Environmental Burden Data ───────────────────────
// Source: Census ACS 5-Year 2018-2022 (Tables S1701, DP05, S2701, S1601, S1501)
// EPA SDWIS: Safe Drinking Water Act violation counts normalized per 100k population
// All percentages are whole numbers (e.g., 12.4 = 12.4%)
//
// Scoring philosophy: Higher values = MORE vulnerable = HIGHER EJ concern
// This aligns with EJScreen convention where higher percentile = more concern

const STATE_EJ_DATA: Record<string, {
  poverty: number;      // % below poverty
  minority: number;     // % non-white (including Hispanic)
  uninsured: number;    // % without health insurance
  lingIso: number;      // % limited English proficiency
  noHS: number;         // % 25+ without HS diploma
  dwViol: number;       // Drinking water violations per 100k pop
}> = {
  AL: { poverty: 15.5, minority: 35.3, uninsured: 9.8, lingIso: 2.1, noHS: 14.1, dwViol: 22 },
  AK: { poverty: 10.2, minority: 38.5, uninsured: 12.6, lingIso: 4.8, noHS: 7.4, dwViol: 45 },
  AZ: { poverty: 14.1, minority: 46.5, uninsured: 10.4, lingIso: 7.2, noHS: 13.5, dwViol: 18 },
  AR: { poverty: 16.2, minority: 27.4, uninsured: 9.5, lingIso: 2.6, noHS: 13.8, dwViol: 28 },
  CA: { poverty: 11.8, minority: 63.7, uninsured: 7.2, lingIso: 9.8, noHS: 16.4, dwViol: 12 },
  CO: { poverty: 9.1,  minority: 33.9, uninsured: 7.1, lingIso: 4.2, noHS: 8.8,  dwViol: 10 },
  CT: { poverty: 9.8,  minority: 34.8, uninsured: 5.7, lingIso: 4.8, noHS: 9.8,  dwViol: 8 },
  DE: { poverty: 11.3, minority: 41.2, uninsured: 6.8, lingIso: 3.5, noHS: 11.2, dwViol: 14 },
  DC: { poverty: 13.5, minority: 59.8, uninsured: 3.8, lingIso: 5.2, noHS: 10.8, dwViol: 6 },
  FL: { poverty: 12.1, minority: 46.1, uninsured: 13.2, lingIso: 8.1, noHS: 12.2, dwViol: 15 },
  GA: { poverty: 13.5, minority: 47.2, uninsured: 12.4, lingIso: 4.5, noHS: 12.8, dwViol: 16 },
  HI: { poverty: 9.3,  minority: 75.4, uninsured: 4.2, lingIso: 8.8, noHS: 8.2,  dwViol: 20 },
  ID: { poverty: 11.2, minority: 18.6, uninsured: 10.8, lingIso: 3.1, noHS: 9.8,  dwViol: 24 },
  IL: { poverty: 11.5, minority: 39.2, uninsured: 7.2, lingIso: 5.8, noHS: 11.2, dwViol: 14 },
  IN: { poverty: 11.4, minority: 22.8, uninsured: 8.4, lingIso: 2.8, noHS: 11.5, dwViol: 18 },
  IA: { poverty: 11.2, minority: 16.2, uninsured: 5.4, lingIso: 2.4, noHS: 8.2,  dwViol: 26 },
  KS: { poverty: 10.3, minority: 24.8, uninsured: 9.2, lingIso: 3.5, noHS: 9.2,  dwViol: 20 },
  KY: { poverty: 16.3, minority: 15.1, uninsured: 6.2, lingIso: 1.8, noHS: 14.4, dwViol: 22 },
  LA: { poverty: 19.0, minority: 40.2, uninsured: 8.6, lingIso: 2.8, noHS: 14.8, dwViol: 32 },
  ME: { poverty: 11.8, minority: 7.2,  uninsured: 8.1, lingIso: 1.2, noHS: 7.4,  dwViol: 18 },
  MD: { poverty: 9.1,  minority: 49.5, uninsured: 6.2, lingIso: 4.8, noHS: 10.2, dwViol: 10 },
  MA: { poverty: 10.4, minority: 29.8, uninsured: 3.2, lingIso: 5.4, noHS: 9.2,  dwViol: 8 },
  MI: { poverty: 13.1, minority: 25.2, uninsured: 6.4, lingIso: 2.8, noHS: 9.8,  dwViol: 16 },
  MN: { poverty: 9.3,  minority: 22.4, uninsured: 5.1, lingIso: 3.2, noHS: 6.8,  dwViol: 12 },
  MS: { poverty: 19.6, minority: 42.1, uninsured: 12.8, lingIso: 1.8, noHS: 16.2, dwViol: 38 },
  MO: { poverty: 12.8, minority: 21.2, uninsured: 9.8, lingIso: 1.8, noHS: 10.4, dwViol: 24 },
  MT: { poverty: 12.1, minority: 13.8, uninsured: 9.4, lingIso: 1.2, noHS: 6.8,  dwViol: 42 },
  NE: { poverty: 10.5, minority: 22.1, uninsured: 8.2, lingIso: 3.4, noHS: 8.8,  dwViol: 18 },
  NV: { poverty: 11.4, minority: 51.2, uninsured: 12.2, lingIso: 7.8, noHS: 14.1, dwViol: 14 },
  NH: { poverty: 7.2,  minority: 10.8, uninsured: 5.8, lingIso: 1.6, noHS: 6.4,  dwViol: 12 },
  NJ: { poverty: 9.4,  minority: 44.8, uninsured: 7.8, lingIso: 6.8, noHS: 10.8, dwViol: 10 },
  NM: { poverty: 18.2, minority: 63.5, uninsured: 11.5, lingIso: 8.2, noHS: 15.2, dwViol: 48 },
  NY: { poverty: 13.1, minority: 44.2, uninsured: 5.8, lingIso: 8.2, noHS: 13.1, dwViol: 12 },
  NC: { poverty: 13.4, minority: 38.8, uninsured: 11.1, lingIso: 3.8, noHS: 12.4, dwViol: 14 },
  ND: { poverty: 11.4, minority: 15.2, uninsured: 8.2, lingIso: 1.4, noHS: 6.2,  dwViol: 34 },
  OH: { poverty: 13.4, minority: 22.5, uninsured: 6.8, lingIso: 2.2, noHS: 10.2, dwViol: 20 },
  OK: { poverty: 15.3, minority: 34.8, uninsured: 14.2, lingIso: 3.4, noHS: 12.8, dwViol: 26 },
  OR: { poverty: 11.2, minority: 26.4, uninsured: 7.8, lingIso: 4.1, noHS: 9.4,  dwViol: 22 },
  PA: { poverty: 11.8, minority: 24.2, uninsured: 6.1, lingIso: 3.2, noHS: 10.1, dwViol: 16 },
  RI: { poverty: 10.3, minority: 28.2, uninsured: 4.2, lingIso: 5.4, noHS: 12.8, dwViol: 10 },
  SC: { poverty: 14.6, minority: 37.8, uninsured: 10.8, lingIso: 2.4, noHS: 13.2, dwViol: 18 },
  SD: { poverty: 13.1, minority: 18.4, uninsured: 10.2, lingIso: 2.1, noHS: 8.4,  dwViol: 36 },
  TN: { poverty: 13.4, minority: 26.2, uninsured: 10.2, lingIso: 2.4, noHS: 13.1, dwViol: 20 },
  TX: { poverty: 14.2, minority: 59.8, uninsured: 18.4, lingIso: 9.2, noHS: 16.8, dwViol: 22 },
  UT: { poverty: 8.8,  minority: 22.4, uninsured: 9.8, lingIso: 3.8, noHS: 8.4,  dwViol: 16 },
  VT: { poverty: 10.4, minority: 7.8,  uninsured: 5.2, lingIso: 1.1, noHS: 6.2,  dwViol: 14 },
  VA: { poverty: 9.6,  minority: 40.2, uninsured: 8.1, lingIso: 4.2, noHS: 10.8, dwViol: 12 },
  WA: { poverty: 10.3, minority: 34.2, uninsured: 6.8, lingIso: 5.1, noHS: 8.8,  dwViol: 14 },
  WV: { poverty: 17.8, minority: 7.5,  uninsured: 6.2, lingIso: 0.8, noHS: 13.8, dwViol: 52 },
  WI: { poverty: 10.6, minority: 20.2, uninsured: 5.8, lingIso: 2.4, noHS: 8.4,  dwViol: 16 },
  WY: { poverty: 9.8,  minority: 16.2, uninsured: 11.4, lingIso: 1.8, noHS: 6.8,  dwViol: 38 },
};

// ── Scoring Algorithm ──────────────────────────────────────────────────────────
// Mirrors EPA EJScreen methodology adapted to state level:
//   Score = Demographic Vulnerability (60%) + Environmental Burden (40%)
//
// Demographic Vulnerability (60%):
//   - Poverty rate (20%): normalized 0-100 where 20%+ = 100
//   - Minority % (10%): normalized 0-100 where 70%+ = 100
//   - Uninsured % (10%): normalized 0-100 where 18%+ = 100
//   - Limited English (10%): normalized 0-100 where 10%+ = 100
//   - No HS diploma (10%): normalized 0-100 where 18%+ = 100
//
// Environmental Burden — Water Focus (40%):
//   - Drinking water violations per 100k (40%): normalized 0-100 where 50+ = 100
//     This is the primary environmental indicator for PEARL relevance —
//     communities with high SDWA violation rates are most in need of
//     water quality intervention
//
// Final score clamped to 0-100

function computeEJScore(d: typeof STATE_EJ_DATA[string]): number {
  // Normalize each component to 0-100
  const povertyNorm = Math.min(100, Math.round((d.poverty / 20) * 100));
  const minorityNorm = Math.min(100, Math.round((d.minority / 70) * 100));
  const uninsuredNorm = Math.min(100, Math.round((d.uninsured / 18) * 100));
  const lingIsoNorm = Math.min(100, Math.round((d.lingIso / 10) * 100));
  const noHSNorm = Math.min(100, Math.round((d.noHS / 18) * 100));
  const dwViolNorm = Math.min(100, Math.round((d.dwViol / 50) * 100));

  // Weighted composite
  const demographic = povertyNorm * 0.20 + minorityNorm * 0.10 + uninsuredNorm * 0.10
                    + lingIsoNorm * 0.10 + noHSNorm * 0.10;
  const environmental = dwViolNorm * 0.40;

  const raw = demographic + environmental;
  return Math.min(100, Math.max(0, Math.round(raw)));
}

// ── Pre-computed scores ────────────────────────────────────────────────────────

const EJ_SCORES: Record<string, EJStateData> = {};
for (const [abbr, data] of Object.entries(STATE_EJ_DATA)) {
  EJ_SCORES[abbr] = {
    abbr,
    povertyPct: data.poverty,
    minorityPct: data.minority,
    uninsuredPct: data.uninsured,
    lingIsolatedPct: data.lingIso,
    noHSDiplomaPct: data.noHS,
    drinkingWaterViol: data.dwViol,
    score: computeEJScore(data),
  };
}

// ── Public API ─────────────────────────────────────────────────────────────────

/**
 * Get EJ vulnerability score for a state (0-100).
 * Returns 0 if state not found.
 */
export function getEJScore(stateAbbr: string): number {
  return EJ_SCORES[stateAbbr.toUpperCase()]?.score ?? 0;
}

/**
 * Get full EJ data for a state.
 */
export function getEJData(stateAbbr: string): EJStateData | null {
  return EJ_SCORES[stateAbbr.toUpperCase()] ?? null;
}

/**
 * Get all state scores as a map (for bulk use in overlays).
 */
export function getAllEJScores(): Record<string, number> {
  const result: Record<string, number> = {};
  for (const [abbr, data] of Object.entries(EJ_SCORES)) {
    result[abbr] = data.score;
  }
  return result;
}

/**
 * Get all state data.
 */
export function getAllEJData(): Record<string, EJStateData> {
  return { ...EJ_SCORES };
}

/**
 * Get a human-readable label for an EJ score.
 */
export function ejScoreLabel(score: number): string {
  if (score >= 80) return 'Very High Concern';
  if (score >= 60) return 'High Concern';
  if (score >= 40) return 'Moderate Concern';
  if (score >= 20) return 'Low Concern';
  return 'Minimal Concern';
}
